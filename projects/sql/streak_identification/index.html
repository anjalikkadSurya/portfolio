<!DOCTYPE HTML>
<html>
<head>
  <title>SQL Streak Detection – Suraj Antony</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="../../assets/css/main.css" />
  <noscript><link rel="stylesheet" href="../../assets/css/noscript.css" /></noscript>
  <style>
    .content-area {
      max-width: 900px;
      margin: auto;
      padding: 3rem 2rem;
    }
    code {
      display: block;
      background: #f6f6f6;
      padding: 1em;
      border-left: 3px solid #ccc;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    img {
      max-width: 100%;
      margin-top: 2rem;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body class="is-preload">
  <div id="page-wrapper">
    <div id="wrapper">
      <!-- Banner -->
      <section class="panel banner right">
        <div class="content color0 span-3-75">
          <h1 class="major">SQL Project<br />
          Longest Active Streaks</h1>
          <p>Identifying the longest consecutive active day streaks for each user from engagement logs.</p>
        </div>
        <div class="image filtered span-1-75" data-position="center">
          <img src="../../images/pic01.jpg" alt="SQL Streak Banner" />
        </div>
      </section>

      <!-- Main Content -->
      <section class="panel">
        <div class="content-area">
          <h2 class="major">Problem Statement</h2>
          <p>You are given a table <code>user_event_data(user_id, event_date, engaged_duration, revenue)</code>. Each row represents a user's engagement on a specific day. Write a SQL query to find the longest streak of consecutive active days for each user. For each user, return:</p>
          <ul>
            <li><code>user_id</code></li>
            <li><code>start_date</code> of the longest streak</li>
            <li><code>end_date</code> of the longest streak</li>
            <li><code>max_streak</code> (number of consecutive days)</li>
          </ul>
          <p>If a user has multiple streaks of the same maximum length, return both ordered by <code>start_date</code> ascending.</p>

          <h2 class="major">SQL Query</h2>
          <code>
with usable_data as
(
	select *, event_date - interval '1 day'*(row_number() over(partition by user_id order by event_date asc)) as date_anchor
	from multi_streak_user_activity_table as a
	where engaged_duration > 1
)
, secondary_data as
(
	select user_id, min(event_date) as start_date, 
	max(event_date) as end_date,
	count(distinct event_date) as streak_length,
	sum(revenue) as revenue_per_streak
	from usable_data as a
	group by user_id, date_anchor
)
, teritary_data as
(
	select *, dense_rank() over(partition by user_id order by streak_length desc) as row_handle
	from secondary_data as a
	where revenue_per_streak > 1
)

select user_id, date(start_date) as start_date, date(end_date) as end_date, round(revenue_per_streak::numeric, 2) as revenue, streak_length as max_streak
from teritary_data as a
where row_handle=1
order by user_id, start_date;
          </code>

          <h2 class="major">Screenshot</h2>
          <img src="streak-output.png" alt="Query Output Screenshot" />

          <p><a href="query.sql" download>Download SQL query</a></p>
          <p><a href="https://anjalikkadsurya.github.io/portfolio/index.html">← Back to Portfolio</a></p>
        </div>
      </section>

      <!-- Footer -->
      <div class="copyright">&copy; Suraj Antony. Design adapted from <a href="https://html5up.net">HTML5 UP</a>.</div>
    </div>
  </div>
  <script src="../../assets/js/jquery.min.js"></script>
  <script src="../../assets/js/browser.min.js"></script>
  <script src="../../assets/js/breakpoints.min.js"></script>
  <script src="../../assets/js/main.js"></script>
</body>
</html>
